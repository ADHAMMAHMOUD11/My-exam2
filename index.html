<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ุงูุชุญุงู - ุฏุฎูู ูุฑุฉ ูุงุญุฏุฉ</title>
<style>
  :root{
    --bg:#fbfdff; --card:#fff; --primary:#0b63d6; --accent:#d32f2f; --muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Tajawal","Cairo",Tahoma,Arial,sans-serif;
    background:linear-gradient(180deg,#f3f8ff,#ffffff); color:#071534; direction:rtl;
  }
  .topbar{height:12px;background:linear-gradient(90deg,var(--accent),#ff8a80);position:relative;overflow:hidden}
  .progress{position:absolute;left:0;top:0;bottom:0;width:100%;background:linear-gradient(90deg,var(--accent),#ff8a80)}
  .wrap{max-width:980px;margin:18px auto;padding:18px}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 12px 30px rgba(7,21,52,0.06)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  h1{margin:0;color:var(--primary);font-size:20px}
  .timer{padding:8px 12px;border-radius:8px;background:rgba(11,99,214,0.06);color:var(--primary);font-weight:700}
  .grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
  .left{padding-right:6px}
  .question{margin-bottom:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border-right:5px solid var(--primary);box-shadow:0 6px 14px rgba(11,63,128,0.03)}
  .question p{margin:0 0 8px;font-weight:700;color:#123}
  label.option{display:block;margin:6px 0;padding:8px;border-radius:8px;cursor:pointer;border:1px solid transparent;transition:all .12s}
  label.option:hover{transform:translateY(-2px);border-color:rgba(11,63,128,0.06)}
  input[type="radio"]{margin-left:8px;transform:scale(1.05)}
  .panel{position:sticky;top:20px;padding:14px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfbff);box-shadow:0 8px 18px rgba(11,63,128,0.05)}
  .panel h3{margin:0 0 8px;color:var(--primary)}
  .actions{text-align:center;margin-top:14px}
  button.primary{background:var(--primary);color:#fff;border:none;padding:12px 18px;border-radius:10px;cursor:pointer;font-weight:800;font-size:16px}
  .locked{padding:18px;text-align:center;color:var(--accent);font-weight:700}
  .result{margin-top:14px;background:#f6fbff;border-radius:10px;padding:12px;border:1px solid #e6f0ff}
  .correct{color:green;font-weight:700}
  .wrong{color:#c62828;font-weight:700}
  footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}
  @media(max-width:880px){ .grid{grid-template-columns:1fr} .panel{position:static;margin-top:12px} }
</style>
</head>
<body>
  <div class="topbar" aria-hidden="true"><div id="progressBar" class="progress" style="width:100%"></div></div>

  <div class="wrap">
    <div class="card">
      <header>
        <h1>ุงูุชุญุงู โ ุฏุฎูู ูุฑุฉ ูุงุญุฏุฉ</h1>
        <div class="timer" aria-live="polite">โฑ ุงูููุช ุงููุชุจูู: <span id="time">25:00</span></div>
      </header>

      <div class="grid" id="mainGrid">
        <div class="left card" id="examCard">
          <form id="quizForm">
            <!-- ุฃุณุฆูุฉ 1..15 -->
            <div class="question" id="q1">
              <p>1. ุฃู ุงูุจุฏุงุฆู ุงูุขุชูุฉ ูุง ููุนุชุจุฑ ูู ููููุงุช ุงููููู ุงูุนุธููุ</p>
              <label class="option"><input type="radio" name="q1" value="a"> ููุญ ุงููุชู</label>
              <label class="option"><input type="radio" name="q1" value="b"> ุงูููุตู</label>
              <label class="option"><input type="radio" name="q1" value="c"> ุงูุฃุฑุจุทุฉ</label>
              <label class="option"><input type="radio" name="q1" value="d"> ููุทูุฉ ุงูุญูุถ</label>
            </div>

            <div class="question" id="q2">
              <p>2. ุงููุณุจุฉ ุจูู ุทูู ุงูุถูุน ุฑูู (6) ุฅูู ุทูู ุงูุถูุน ุฑูู (1):</p>
              <label class="option"><input type="radio" name="q2" value="a"> ุฃูุจุฑ ูู ูุงุญุฏ</label>
              <label class="option"><input type="radio" name="q2" value="b"> ุฃูู ูู ูุงุญุฏ</label>
              <label class="option"><input type="radio" name="q2" value="c"> ูุณุงูู ูุงุญุฏ</label>
              <label class="option"><input type="radio" name="q2" value="d"> ูุง ูููู ุชุญุฏูุฏู</label>
            </div>

            <div class="question" id="q3">
              <p>3. ุงููุณุจุฉ ุจูู ุนุฏุฏ ุนุธุงู ุงูุญุฒุงู ุงูุญูุถู ุฅูู ุนุธุงู ุงูุญุฒุงู ุงูุตุฏุฑู ููุณุจุฉ:</p>
              <label class="option"><input type="radio" name="q3" value="a">(1 ุฅูู 2)</label>
              <label class="option"><input type="radio" name="q3" value="b">(1 ุฅูู 1)</label>
              <label class="option"><input type="radio" name="q3" value="c">(3 ุฅูู 2)</label>
              <label class="option"><input type="radio" name="q3" value="d">(2 ุฅูู 1)</label>
            </div>

            <div class="question" id="q4">
              <p>4. ุฃูุจุฑ ุชุฌุงููู ุงููููู ุงูุทุฑูู ุนูููุง:</p>
              <label class="option"><input type="radio" name="q4" value="a"> ุชุฌููู ุงูุฒูุฏ</label>
              <label class="option"><input type="radio" name="q4" value="b"> ุงูุชุฌููู ุงูุญููููู</label>
              <label class="option"><input type="radio" name="q4" value="c"> ุงูุชุฌููู ุงูุฃุฑูุญ</label>
              <label class="option"><input type="radio" name="q4" value="d"> ูููู ููุตู ูุญุฏูุฏ ุงูุญุฑูุฉ</label>
            </div>

            <div class="question" id="q5">
              <p>5. ุชูุฏู ุญุฑูุฉ ุงูุฌุฐูุฑ ุงูุดุงุฏูุฉ ุฅูู:</p>
              <label class="option"><input type="radio" name="q5" value="a"> ุชุฃููู ุณุงู ุงููุจุงุช ูุงูุฃูุฑุงู</label>
              <label class="option"><input type="radio" name="q5" value="b"> ุฒูุงุฏุฉ ุทูู ุงูุฌุฐูุฑ ุงูุดุงุฏูุฉ</label>
              <label class="option"><input type="radio" name="q5" value="c"> ุฒูุงุฏุฉ ุงููุฏุฑุฉ ุนูู ุงูุชุตุงุต ุงููุงุก</label>
              <label class="option"><input type="radio" name="q5" value="d"> ุฒูุงุฏุฉ ูุฏุฑุฉ ุงููุจุงุช ุนูู ุงูููุงู ุจุนูููุฉ ุงูุจูุงุก ุงูุถูุฆู</label>
            </div>

            <div class="question" id="q6">
              <p>6. ุฃู ุงููุคุซุฑุงุช ุงูุชุงููุฉ ุชุฒูุฏ ูู ุณุฑุนุฉ ุชุจุงุนุฏ ูุฑููุงุช ุงููุณุชุญูุฉุ</p>
              <label class="option"><input type="radio" name="q6" value="a"> ุณููุท ุงูุฃูุทุงุฑ</label>
              <label class="option"><input type="radio" name="q6" value="b"> ุงูุธูุงู</label>
              <label class="option"><input type="radio" name="q6" value="c"> ุงูุถูุก</label>
            </div>

            <div class="question" id="q7">
              <p>7. ูููู ุงูุงุณุชุฏูุงู ุนูู ุญุฏูุซ ุงูุงูุณูุงุจ ุงูุณูุชูุจูุงุฒูู ุจุญุฑูุฉ:</p>
              <label class="option"><input type="radio" name="q7" value="a"> ุนุถููุงุช ุชุชุตู ุจุชุนุฏุฏ ุฃููุงููุง</label>
              <label class="option"><input type="radio" name="q7" value="b"> ุนุถูุงุช ุนุฏููุฉ ุงูููู</label>
              <label class="option"><input type="radio" name="q7" value="c"> ุงูุฌุฏุงุฑ ุงูุฎููู</label>
              <label class="option"><input type="radio" name="q7" value="d"> ุงูุบุดุงุก ุงูุฎููู</label>
            </div>

            <div class="question" id="q8">
              <p>8. ุชุชููู ุงูุนุถูุงุช ูู ุฃูุณุฌุฉ ุนุถููุฉ ุชุนุฑู ุจู:</p>
              <label class="option"><input type="radio" name="q8" value="a"> ุงููุญู</label>
              <label class="option"><input type="radio" name="q8" value="b"> ุงูุฎูุงูุง ุงูุนุถููุฉ</label>
              <label class="option"><input type="radio" name="q8" value="c"> ุงูููููุงุช ุงูุนุถููุฉ</label>
              <label class="option"><input type="radio" name="q8" value="d"> ุงููุทุน ุงูุนุถููุฉ</label>
            </div>

            <div class="question" id="q9">
              <p>9. ุงูุฃูููุงุช ุงูุชู ูุฑุชุจุท ูุนุฏู ูุฑูุฑูุง ุฎูุงู ุบุดุงุก ุงููููุฉ ุงูุนุถููุฉ ุจุฅุซุงุฑุฉ ุงูุนุถูุฉ:</p>
              <label class="option"><input type="radio" name="q9" value="a"> ุงูุตูุฏููู</label>
              <label class="option"><input type="radio" name="q9" value="b"> ุงููุงูุณููู ูุงูุตูุฏููู</label>
              <label class="option"><input type="radio" name="q9" value="c"> ุงููููุฑ ูุงูุจุฑูุชูู</label>
              <label class="option"><input type="radio" name="q9" value="d"> ุงููุงูุณููู ูุงูุจูุชุงุณููู</label>
            </div>

            <div class="question" id="q10">
              <p>10. ุชููู ุฎูุงูุง ุงูุนุถูุงุช ุงูุชู ุชููู ุจูุดุงุท ุนููู ูุณุจุฉ ุนุงููุฉ ูู:</p>
              <label class="option"><input type="radio" name="q10" value="a"> ุญูุถ ุงููุงูุชูู</label>
              <label class="option"><input type="radio" name="q10" value="b"> ุญูุถ ุงูุจูุฑูููู</label>
              <label class="option"><input type="radio" name="q10" value="c"> ุญูุถ ุงูุณุชุฑูู</label>
              <label class="option"><input type="radio" name="q10" value="d"> ุญูุถ ุงูุฃุณูุชูู</label>
            </div>

            <div class="question" id="q11">
              <p>11. ูู ุฃุณุจุงุจ ุงูุฅุฌูุงุฏ ุงูุณุฑูุน ูุนุถูุฉ ุงููุฎุฐ:</p>
              <label class="option"><input type="radio" name="q11" value="a"> ุฒูุงุฏุฉ ูุณุจุฉ ุงูุฌููููุฌูู ุจุงูุนุถูุฉ</label>
              <label class="option"><input type="radio" name="q11" value="b"> ุถูู ุงูุดุฑุงููู ุงููุบุฐูุฉ ููุนุถูุฉ</label>
              <label class="option"><input type="radio" name="q11" value="c"> ุฒูุงุฏุฉ ุงูุฃูุณุฌูู ุงููุงุฑุฏ ููุนุถูุฉ</label>
              <label class="option"><input type="radio" name="q11" value="d"> ููุต ุซุงูู ุฃูุณูุฏ ุงููุฑุจูู ุจุงูุนุถูุฉ</label>
            </div>

            <div class="question" id="q12">
              <p>12. ุงููุณุจุฉ ุจูู ุญุฌู ุนุธูุฉ ุงูููุนุฑุฉ ุฅูู ุญุฌู ุนุธูุฉ ุงูุฒูุฏ:</p>
              <label class="option"><input type="radio" name="q12" value="a"> ุชุณุงูู ูุงุญุฏ</label>
              <label class="option"><input type="radio" name="q12" value="b"> ุฃูู ูู ูุงุญุฏ</label>
              <label class="option"><input type="radio" name="q12" value="c"> ุฃูุจุฑ ูู ูุงุญุฏ</label>
              <label class="option"><input type="radio" name="q12" value="d"> ูุง ูููู ุชุญุฏูุฏู</label>
            </div>

            <div class="question" id="q13">
              <p>13. ุงูุญููุฉ ุงูุดูููุฉ ูู ุญููุฉ ุนุธููุฉ ุชุชุตู ุจุงูุฌุฒุก ุงูุฎุงุต ุจู:</p>
              <label class="option"><input type="radio" name="q13" value="a"> ุงูุถูุน ุฑูู (2)</label>
              <label class="option"><input type="radio" name="q13" value="b"> ุงููุชูุก ุงูุดููู</label>
              <label class="option"><input type="radio" name="q13" value="c"> ุนุธูุฉ ุงููุต</label>
              <label class="option"><input type="radio" name="q13" value="d"> ุฌุณู ุงูููุฑุฉ ุงููุทููุฉ</label>
            </div>

            <div class="question" id="q14">
              <p>14. ุชุชุบุฐู ุงูุบุถุงุฑูู ุนู ุทุฑูู:</p>
              <label class="option"><input type="radio" name="q14" value="a"> ุฃูุนูุฉ ุฏูููุฉ ุดุฑูุงููุฉ</label>
              <label class="option"><input type="radio" name="q14" value="b"> ุฃูุนูุฉ ุฏูููุฉ ูุฑูุฏูุฉ</label>
              <label class="option"><input type="radio" name="q14" value="c"> ุงูุงูุชุดุงุฑ ูู ุงูุนุธุงู</label>
              <label class="option"><input type="radio" name="q14" value="d"> ุงูุงุณููุฒูุฉ ูู ุงูุนุธุงู</label>
            </div>

            <div class="question" id="q15">
              <p>15. ุฃุตุบุฑ ูุญุฏุฉ ุชุฎุฒูู ูู:</p>
              <label class="option"><input type="radio" name="q15" value="a"> ุงูุฃูุฑุงุต ุงูุจุฑูุชูููุฉ</label>
              <label class="option"><input type="radio" name="q15" value="b"> ุงููููุฉ ุงูุนุถููุฉ</label>
              <label class="option"><input type="radio" name="q15" value="c"> ุงููุทุนุฉ ุงูุนุถููุฉ</label>
            </div>

          </form>

          <div class="actions">
            <button id="submitBtn" class="primary">ุชุณููู</button>
          </div>

        </div>

        <aside>
          <div class="panel card">
            <h3>ูุนูููุงุช</h3>
            <div style="font-size:13px;color:var(--muted)">
              ุงูุงูุชุญุงู ููุชุญ ูุฑุฉ ูุงุญุฏุฉ ููุท ูู ูุฐุง ุงููุชุตูุญ. ุงูุฎุฑูุฌ/ุงูุชุญุฏูุซ ููุญุชุณุจ ูุชุณููู ุชููุงุฆู.
            </div>
          </div>
        </aside>
      </div>

      <!-- ููุทูุฉ ุงููุชุงุฆุฌ (ุชูุธูุฑ ุจุนุฏ ุงูุชุณููู) -->
      <div id="resultsArea" style="display:none" class="card result"></div>

      <div id="locked" class="card" style="display:none;margin-top:12px">
        <div class="locked">โ๏ธ ูุฐุง ุงูุงูุชุญุงู ูุบูู โ ููุฏ ุชู ุงูุชูุฏูู ุจุงููุนู ูู ูุฐุง ุงููุชุตูุญ.</div>
        <div style="text-align:center;margin-top:8px;color:var(--muted)">ุชู ุงูุชุณููู ุจุชุงุฑูุฎ: <span id="takenAt"></span></div>
        <div style="text-align:center;margin-top:6px;color:var(--muted)">ุงููุฏุฉ ุงููุณุชุบุฑูุฉ: <span id="duration"></span></div>
      </div>

      <footer>ยฉ ุฌููุน ุงูุญููู ูุญููุธุฉ ู ุฃุฏูู 2025</footer>
    </div>
  </div>

<script>
(function(){
  const WA_NUMBER = "+201102323525"; // ุณูุชู ุงุณุชุฎุฏุงูู ุฏุงุฎู ุงูููุฏ ููุท (ูู ูุธูุฑ ูู ุงูุตูุญุฉ)
  const STORAGE_KEY = "exam_one_time_auto_send_v1";
  const TOTAL_SECONDS = 25 * 60; // 25 ุฏูููุฉ

  // ูุงุฆูุฉ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ
  const correctAnswers = {
    q1:"d", q2:"a", q3:"a", q4:"b", q5:"a",
    q6:"c", q7:"a", q8:"a", q9:"a", q10:"a",
    q11:"b", q12:"b", q13:"d", q14:"c", q15:"c"
  };

  // ุนูุงุตุฑ DOM
  const form = document.getElementById("quizForm");
  const submitBtn = document.getElementById("submitBtn");
  const timeSpan = document.getElementById("time");
  const progressBar = document.getElementById("progressBar");
  const resultsArea = document.getElementById("resultsArea");
  const lockedCard = document.getElementById("locked");
  const takenAtSpan = document.getElementById("takenAt");
  const durationSpan = document.getElementById("duration");
  const examCard = document.getElementById("examCard");

  // ููุน ุฅุนุงุฏุฉ ุงูุฏุฎูู ูู ุงุชุณูู ูุจู ูุฏู
  const prev = localStorage.getItem(STORAGE_KEY);
  if (prev) {
    // ุงููุงู ุงูููุฑู ูุนุฑุถ ุฑุณุงูุฉ
    form.style.display = "none";
    document.getElementById("submitBtn").style.display = "none";
    lockedCard.style.display = "block";
    try {
      const p = JSON.parse(prev);
      takenAtSpan.textContent = new Date(p.takenAt).toLocaleString("ar-EG");
      durationSpan.textContent = formatDuration(p.durationSeconds || 0);
      timeSpan.textContent = "00:00";
      updateProgress(0);
      // ุนุฑุถ ูุชุงุฆุฌ ูุญููุธุฉ
      showResultsFromPayload(p);
    } catch(e){
      takenAtSpan.textContent = "ุชู ุณุงุจููุง";
    }
    return;
  }

  // ุนุฏุงุฏ ุชูุงุฒูู
  let remaining = TOTAL_SECONDS;
  const startTime = Date.now();
  let timer = setInterval(() => {
    remaining--;
    if (remaining < 0) remaining = 0;
    const m = Math.floor(remaining/60).toString().padStart(2,"0");
    const s = (remaining%60).toString().padStart(2,"0");
    timeSpan.textContent = `${m}:${s}`;
    updateProgress(remaining / TOTAL_SECONDS);
    if (remaining === 0) finalizeExam("ุงูุชูู ุงูููุช", false);
  },1000);

  function updateProgress(fraction){
    const percent = Math.max(0, Math.min(1, fraction)) * 100;
    progressBar.style.width = percent + "%";
  }

  document.addEventListener("contextmenu", e => e.preventDefault());
  document.addEventListener("keydown", function(e){
    if (e.key === "F5" || (e.ctrlKey && e.key.toLowerCase() === "r")) {
      e.preventDefault();
      finalizeExam("ูุญุงููุฉ ุชุญุฏูุซ/ุฅุนุงุฏุฉ ุชุญููู", false);
    }
  });

  // ุฌูุน ุงูุฅุฌุงุจุงุช
  function collectAnswers(){
    const data = {};
    for (let i=1;i<=15;i++){
      const q = "q"+i;
      const sel = document.querySelector(`input[name="${q}"]:checked`);
      data[q] = sel ? sel.value : "ูู ูุฌุจ";
    }
    return data;
  }

  // ุญุณุงุจ ุงููุชูุฌุฉ ูุชูุตูู ุงูุฃุฎุทุงุก
  function grade(data){
    let correct = 0;
    const wrongDetails = [];
    for (let i=1;i<=15;i++){
      const q = "q"+i;
      const ans = data[q];
      if (ans === correctAnswers[q]) correct++;
      else {
        wrongDetails.push({
          question: i,
          chosen: ans,
          correct: correctAnswers[q]
        });
      }
    }
    return {correct, total:15, percent: Math.round((correct/15)*100), wrongDetails};
  }

  // ุชููุฆุฉ ุฑุณุงูุฉ ูุงุชุณุงุจ (ุชูุตูููุฉ)
  function buildWhatsAppMessage(payload){
    const scoring = payload.score;
    const takenAt = new Date(payload.takenAt);
    let wrongText = "";
    if (scoring.wrongDetails.length === 0) wrongText = "ูุง ุชูุฌุฏ ุฃุฎุทุงุก โ ุฌููุน ุงูุฃุณุฆูุฉ ุตุญูุญุฉ โ";
    else {
      for (const w of scoring.wrongDetails) {
        wrongText += `- ุณุคุงู ${w.question}: ุบูุท (ุงุฎุชุงุฑ: ${w.chosen}) โ ุงูุตุญ: ${w.correct}\n`;
      }
    }
    const msg =
`๐ ูุชูุฌุฉ ุงูุชุญุงู ุงูุทุงูุจ
โ ุนุฏุฏ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ: ${scoring.correct} ูู ${scoring.total}
โ ุนุฏุฏ ุงูุฃุฎุทุงุก: ${scoring.total - scoring.correct}

${scoring.wrongDetails.length ? "ุชูุงุตูู ุงูุฃุฎุทุงุก:\n" : ""}${wrongText}
โฑ ุงููุฏุฉ ุงููุณุชุบุฑูุฉ: ${formatDuration(payload.durationSeconds)}
๐ ููุช ุงูุงูุชูุงุก: ${takenAt.toLocaleString("ar-EG")}

๐ ุดูุฑูุง ููุดุงุฑูุฉ ุงูุทุงูุจ ูู ุงูุงูุชุญุงู โ ูุชููู ูู ุงูุชูููู ๐`;
    return msg;
  }

  // ุฅุธูุงุฑ ุงููุชุงุฆุฌ ุนูู ุงูุตูุญุฉ ุจุนุฏ ุงูุชุณููู
  function showResults(payload){
    const scoring = payload.score;
    const responses = payload.responses;
    const container = document.createElement("div");
    container.innerHTML = `<h3>ุงููุชูุฌุฉ</h3>
      <p><strong>โ ุนุฏุฏ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ:</strong> ${scoring.correct} ูู ${scoring.total}</p>
      <p><strong>โฑ ุงููุฏุฉ ุงููุณุชุบุฑูุฉ:</strong> ${formatDuration(payload.durationSeconds)}</p>
      <hr/>`;
    // ููู ุณุคุงู: ุงุดูุฑ ุฅู ูุงู ุตุญ ุฃู ุบูุท ูุงุนุฑุถ ุงูุตุญ ูู ุบูุท
    const list = document.createElement("div");
    for (let i=1;i<=15;i++){
      const q = "q"+i;
      const chosen = responses[q];
      const correct = correctAnswers[q];
      const block = document.createElement("div");
      block.style.marginBottom = "8px";
      if (chosen === correct) {
        block.innerHTML = `<span class="correct">ุณ${i}: โ ุฅุฌุงุจุฉ ุตุญูุญุฉ</span>`;
      } else {
        block.innerHTML = `<span class="wrong">ุณ${i}: โ ุฎุทุฃ โ ุงุฎุชุฑุช: ${chosen}  โ  ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: ${correct}</span>`;
      }
      list.appendChild(block);
    }
    container.appendChild(list);
    resultsArea.innerHTML = "";
    resultsArea.appendChild(container);
    resultsArea.style.display = "block";
  }

  // ุนุฑุถ ูุชุงุฆุฌ ูุญููุธุฉ (ุนูุฏ ุฅุนุงุฏุฉ ุชุญููู ุจุนุฏ ุชุณููู)
  function showResultsFromPayload(p){
    try {
      showResults(p);
    } catch(e){}
  }

  // ุชูุณูู ูุฏุฉ
  function formatDuration(sec){
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${m} ุฏูููุฉ ู ${s} ุซุงููุฉ`;
  }

  // ุฏุงูุฉ ุฅููุงุก ุงูุงูุชุญุงู (ุชุณููู) - triggeredBySubmit=true ุนูุฏูุง ูุถุบุท ุงูุฒุฑ
  function finalizeExam(reason, triggeredBySubmit){
    if (localStorage.getItem(STORAGE_KEY)) return;
    clearInterval(timer);

    const responses = collectAnswers();
    const scoring = grade(responses);

    const takenAt = new Date();
    const durationSeconds = Math.max(0, Math.round((takenAt.getTime() - startTime)/1000));

    const payload = {
      takenAt: takenAt.toISOString(),
      reason: reason || "submitted",
      score: scoring,
      responses: responses,
      durationSeconds: durationSeconds
    };

    // ุงุญูุธ ุงูุญุงูุฉ ููุฑูุง
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); } catch(e){ console.warn(e); }

    // ูู ุงูุชุณููู ุจูุงุณุทุฉ ุฒุฑ (ุชูุงุนู ูุจุงุดุฑ) ููุชุญ ูุงุชุณุงุจ ุฃููุงู ุซู ูุนุฑุถ ุงููุชุงุฆุฌ
    if (triggeredBySubmit) {
      const waMsg = buildWhatsAppMessage(payload);
      const encoded = encodeURIComponent(waMsg);
      const waUrl = `https://wa.me/${WA_NUMBER.replace(/^\+/, "")}?text=${encoded}`;
      // ูุชุญ ูุงูุฐุฉ ูุงุชุณุงุจ (ูููุนู ูุฃู ูุฐุง ุถูู ุญุฏุซ ููุฑ ุงููุณุชุฎุฏู)
      try {
        window.open(waUrl, "_blank");
      } catch(e) { console.warn("ูุชุญ ูุงุชุณุงุจ ูุดู:", e); }
    }

    // ุงููุงู ุงูุงูุชุญุงู ูู ุงูุตูุญุฉ ูููุน ุงูุชูุงุนู
    form.style.display = "none";
    submitBtn.style.display = "none";
    // ุนุฑุถ ูุชุงุฆุฌ ูุจูุงูุงุช ุงูุชุณููู
    resultsArea.style.display = "block";
    showResults(payload);
    lockedCard.style.display = "block";
    takenAtSpan.textContent = new Date(payload.takenAt).toLocaleString("ar-EG");
    durationSpan.textContent = formatDuration(durationSeconds);
    timeSpan.textContent = "00:00";
    updateProgress(0);

    // ููุจูู ุงูุทุงูุจ
    try { alert("ุชู ุชุณููู ุงูุงูุชุญุงู โ\nุงููุชูุฌุฉ ุฃูุฑุณููุช ุนูู ูุงุชุณุงุจ. ุณูุชู ุฅุบูุงู ุงูุงูุชุญุงู ููู ููููู ุฅุนุงุฏุฉ ุงูุฏุฎูู ูู ููุณ ุงููุชุตูุญ."); } catch(e){}
  }

  // ุฒุฑ ุงูุชุณููู
  submitBtn.addEventListener("click", function(e){
    e.preventDefault();
    // ุชุฃูุฏ ุนูู ุงูุฃูู ูู ุงุฎุชูุงุฑ ุดูุก (ูุด ุฅุฌุจุงุฑู ูู ุงูุฃุณุฆูุฉ)
    if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุฃูู ุชุฑูุฏ ุชุณููู ุงูุงูุชุญุงู ุงูุขูุ ุจุนุฏ ุงูุชุณููู ูู ุชุชููู ูู ุฅุนุงุฏุฉ ุงูุฏุฎูู.")) return;
    finalizeExam("ุชุณููู ูุฏูู", true);
  });

  // ุฅุฐุง ุฃุบูู/ุบูุฑ ุชุจููุจ => ูุนุชุจุฑูุง ุชุณููููุง (ูุณุฌู ููู ูุง ููุชุญ ูุงุชุณุงุจ)
  function handleLeave(){
    if (localStorage.getItem(STORAGE_KEY)) return;
    finalizeExam("ุงูุฎุฑูุฌ ูู ุงูุตูุญุฉ/ุฅุบูุงู", false);
  }
  window.addEventListener("pagehide", handleLeave);
  document.addEventListener("visibilitychange", function(){ if (document.visibilityState === "hidden") handleLeave(); });

  // ูุฑุงูุจุฉ localStorage ูู ุชุจููุจ ุขุฎุฑ
  window.addEventListener("storage", function(e){
    if (e.key === STORAGE_KEY && e.newValue) {
      try {
        const p = JSON.parse(e.newValue);
        form.style.display = "none";
        submitBtn.style.display = "none";
        lockedCard.style.display = "block";
        showResults(p);
        takenAtSpan.textContent = new Date(p.takenAt).toLocaleString("ar-EG");
        durationSpan.textContent = formatDuration(p.durationSeconds || 0);
        timeSpan.textContent = "00:00";
        updateProgress(0);
      } catch(_) {}
    }
  });

})();
</script>
</body>
                                      </html>
